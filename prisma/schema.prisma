generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

enum MovementType {
    IN
    OUT
}

model Plan {
    id       String  @id @default(uuid())
    name     String  @unique // Ej: "Plan Emprendedor"
    code     String  @unique // Ej: "STARTER_MONTHLY"
    price    Decimal @default(0)
    currency String  @default("USD")

    // Límites del plan guardados en JSON
    // Ej: { "maxUsers": 5, "maxWarehouses": 1, "canExport": false }
    limits Json? @default("{}")

    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())

    companies Company[] // Relación inversa
}

model Company {
    id        String   @id @default(uuid())
    name      String   @unique
    taxId     String?  @unique
    email     String?
    phone     String?
    address   String?
    logoUrl   String?
    planId    String?
    plan      Plan?    @relation(fields: [planId], references: [id])
    active    Boolean  @default(true)
    config    Json?    @default("{}")
    createdAt DateTime @default(now())

    users               UserCompany[]
    products            Product[]
    warehouses          Warehouse[]
    movements           StockMovement[]
    moneyMovements      MoneyMovement[]
    moneyCategories     MoneyCategory[]
    cashSessions        CashSession[]
    productCosts        ProductCost[]
    deliveryZones       DeliveryZone[]
    customers           Customer[]
    sales               Sale[]
    salesBySaleCategory SalesBySaleCategory[]
    orders              Order[]
    suppliers           Supplier[]
    purchases           Purchase[]
    promotions          Promotion[]
    productCategories   ProductCategory[]
    productNoRotations  ProductNoRotation[]
    modifierGroups      ModifierGroup[]
    cashDailies         CashDaily[]
    companyModules      CompanyModule[]
    salesDailies        SalesDaily[]
    profitByProducts    ProfitByProduct[]
    salesByProducts     SalesByProduct[]
    salesByCategories   SalesByCategory[]
    saleCategories      SaleCategory[]
    productPrices       ProductPrice[]
}

enum UserType {
    COMPANY
    PLATFORM
}

model User {
    id                String    @id @default(uuid())
    firstName         String
    lastName          String
    alias             String?
    phone             String?   @unique
    email             String    @unique
    password          String
    active            Boolean   @default(true)
    type              UserType  @default(COMPANY)
    createdAt         DateTime  @default(now())
    invitationToken   String?   @unique
    invitationExpires DateTime?

    cashSessions   CashSession[]
    companies      UserCompany[]
    orders         Order[]
    sales          Sale[]
    stockMovements StockMovement[]
    moneyMovements MoneyMovement[]
    refreshTokens  RefreshToken[]
}

model UserCompany {
    id        String  @id @default(uuid())
    userId    String
    companyId String
    role      Role
    active    Boolean @default(true)

    user    User    @relation(fields: [userId], references: [id])
    company Company @relation(fields: [companyId], references: [id])

    @@unique([userId, companyId])
}

model Product {
    id        String   @id @default(uuid())
    companyId String
    name      String
    sku       String?
    active    Boolean  @default(true)
    createdAt DateTime @default(now())
    price     Decimal  @default(0)
    barcode   String?

    prices        ProductPrice[]
    stocks        Stock[]
    movements     StockMovement[]
    costs         ProductCost[]
    salesItems    SaleItem[]
    orderItems    OrderItem[]
    purchaseItems PurchaseItem[]
    components    ProductComponent[] @relation("ProductParent")
    usedIn        ProductComponent[] @relation("ProductComponent")
    company       Company            @relation(fields: [companyId], references: [id])

    promotions            PromotionItem[]
    productNoRotations    ProductNoRotation[]
    productModifierGroups ProductModifierGroup[]
    profitByProducts      ProfitByProduct[]
    salesByProducts       SalesByProduct[]
    productCategory       ProductCategory?       @relation(fields: [productCategoryId], references: [id])
    productCategoryId     String?

    @@unique([companyId, sku])
    @@index([companyId])
    @@index([companyId, active])
    @@index([companyId, barcode])
}

model ProductComponent {
    id          String  @id @default(uuid())
    parentId    String
    componentId String
    quantity    Decimal

    parent    Product @relation("ProductParent", fields: [parentId], references: [id])
    component Product @relation("ProductComponent", fields: [componentId], references: [id])

    @@unique([parentId, componentId])
}

model ProductPrice {
    id        String   @id @default(uuid())
    productId String
    companyId String
    price     Decimal
    reason    String?
    createdAt DateTime @default(now())

    product Product @relation(fields: [productId], references: [id])
    company Company @relation(fields: [companyId], references: [id])

    @@index([productId])
}

model Warehouse {
    id        String   @id @default(uuid())
    companyId String
    name      String
    active    Boolean  @default(true)
    createdAt DateTime @default(now())

    company        Company         @relation(fields: [companyId], references: [id])
    stocks         Stock[]
    stockMovements StockMovement[]
    purchases      Purchase[]
    orders         Order[]
    sales          Sale[]

    @@index([companyId, active])
}

model Stock {
    id          String  @id @default(uuid())
    productId   String
    warehouseId String
    quantity    Decimal @default(0)

    product   Product   @relation(fields: [productId], references: [id])
    warehouse Warehouse @relation(fields: [warehouseId], references: [id])

    @@unique([productId, warehouseId])
    @@index([warehouseId, quantity])
}

enum StockReferenceType {
    SALE
    ORDER
    PURCHASE
    ADJUSTMENT
    TRANSFER
    ORDER_RESERVATION
}

model StockMovement {
    id            String              @id @default(uuid())
    companyId     String
    productId     String
    warehouseId   String
    type          MovementType
    quantity      Decimal
    referenceType StockReferenceType?
    referenceId   String?
    notes         String?

    createdAt   DateTime @default(now())
    createdById String?
    createdBy   User?    @relation(fields: [createdById], references: [id])

    company   Company   @relation(fields: [companyId], references: [id])
    product   Product   @relation(fields: [productId], references: [id])
    warehouse Warehouse @relation(fields: [warehouseId], references: [id])

    @@index([createdAt])
    @@index([companyId, productId])
    @@index([warehouseId])
    @@index([companyId, productId, createdAt])
    @@index([companyId, warehouseId, createdAt])
}

enum PaymentMethod {
    CASH
    CARD
    TRANSFER
    VIRTUAL
    CHECK
}

enum MoneyType {
    IN
    OUT
}

model MoneyCategory {
    id             String          @id @default(uuid())
    companyId      String
    name           String
    type           MoneyType
    moneyMovements MoneyMovement[]

    company Company @relation(fields: [companyId], references: [id])

    @@index([companyId])
}

enum MoneyReferenceType {
    SALE
    ORDER
    CASH_SESSION
    PURCHASE
}

model MoneyMovement {
    id            String              @id @default(uuid())
    companyId     String
    type          MoneyType
    amount        Decimal
    paymentMethod PaymentMethod
    categoryId    String?
    description   String?
    referenceType MoneyReferenceType?
    referenceId   String?
    createdAt     DateTime            @default(now())
    createdById   String?

    createdBy User?          @relation(fields: [createdById], references: [id])
    company   Company        @relation(fields: [companyId], references: [id])
    category  MoneyCategory? @relation(fields: [categoryId], references: [id])

    @@index([createdAt])
    @@index([companyId, createdAt])
    @@index([companyId, createdAt, type])
    @@index([companyId, paymentMethod, createdAt])
    @@index([companyId, categoryId, createdAt])
}

model CashSession {
    id                String             @id @default(uuid())
    companyId         String
    openedById        String
    openedAt          DateTime           @default(now())
    closedAt          DateTime?
    openingCash       Decimal
    closingCash       Decimal?
    difference        Decimal?
    cashDenominations CashDenomination[]

    company  Company @relation(fields: [companyId], references: [id])
    openedBy User    @relation(fields: [openedById], references: [id])

    @@index([companyId, openedAt])
}

model CashDenomination {
    id            String      @id @default(uuid())
    cashSessionId String
    value         Int
    quantity      Int
    cashSession   CashSession @relation(fields: [cashSessionId], references: [id])

    @@unique([cashSessionId, value])
}

model ProductCost {
    id        String   @id @default(uuid())
    productId String
    companyId String
    cost      Decimal
    reason    String?
    createdAt DateTime @default(now())

    product Product @relation(fields: [productId], references: [id])
    company Company @relation(fields: [companyId], references: [id])

    @@index([productId])
}

model DeliveryZone {
    id        String   @id @default(uuid())
    companyId String
    name      String
    price     Decimal
    active    Boolean  @default(true)
    notes     String?
    createdAt DateTime @default(now())

    company Company @relation(fields: [companyId], references: [id])
    orders  Order[]

    @@unique([companyId, name])
    @@index([companyId])
}

model Sale {
    id             String     @id @default(uuid())
    companyId      String
    createdById    String
    subtotal       Decimal
    discount       Decimal?
    total          Decimal
    deliveryFee    Decimal?
    createdAt      DateTime   @default(now())
    orderId        String?
    saleCategoryId String?
    status         SaleStatus @default(COMPLETED)
    warehouseId    String
    customerId     String?
    notes          String?

    warehouse     Warehouse     @relation(fields: [warehouseId], references: [id])
    order         Order?        @relation(fields: [orderId], references: [id])
    company       Company       @relation(fields: [companyId], references: [id])
    createdBy     User          @relation(fields: [createdById], references: [id])
    paymentStatus PaymentStatus @default(PENDING)
    items         SaleItem[]
    payments      SalePayment[]
    saleCategory  SaleCategory? @relation(fields: [saleCategoryId], references: [id])
    customer      Customer?     @relation(fields: [customerId], references: [id])

    @@index([createdAt])
    @@index([companyId, createdAt])
    @@index([companyId, paymentStatus, createdAt])
    @@index([companyId, warehouseId])
}

model SaleItem {
    id        String   @id @default(uuid())
    saleId    String
    productId String
    quantity  Decimal
    price     Decimal
    basePrice Decimal
    discount  Decimal?
    cost      Decimal

    modifiers SaleItemModifier[]
    sale      Sale               @relation(fields: [saleId], references: [id])
    product   Product            @relation(fields: [productId], references: [id])

    @@index([productId])
}

model SalePayment {
    id            String        @id @default(uuid())
    saleId        String
    amount        Decimal
    paymentMethod PaymentMethod
    createdAt     DateTime      @default(now())
    reference     String?

    sale Sale @relation(fields: [saleId], references: [id])

    @@index([paymentMethod, createdAt])
}

model Customer {
    id        String  @id @default(uuid())
    companyId String
    name      String
    phone     String?
    address   String?
    orders    Order[]
    active    Boolean @default(true)

    company Company @relation(fields: [companyId], references: [id])
    sales   Sale[]

    @@index([companyId, active])
}

enum OrderStatus {
    PENDING
    CONFIRMED
    PREPARING
    READY
    DELIVERED
    CANCELED
}

model Order {
    id             String      @id @default(uuid())
    companyId      String
    createdById    String?
    createdAt      DateTime    @default(now())
    customerId     String?
    status         OrderStatus @default(PENDING)
    deliveryFee    Decimal?
    subtotal       Decimal
    discount       Decimal?
    total          Decimal
    deliveryZoneId String?
    warehouseId    String
    notes          String?

    warehouse     Warehouse     @relation(fields: [warehouseId], references: [id])
    company       Company       @relation(fields: [companyId], references: [id])
    createdBy     User?         @relation(fields: [createdById], references: [id])
    customer      Customer?     @relation(fields: [customerId], references: [id])
    zone          DeliveryZone? @relation(fields: [deliveryZoneId], references: [id])
    paymentStatus PaymentStatus @default(PENDING)

    items    OrderItem[]
    payments OrderPayment[]
    sales    Sale[]

    @@index([createdAt])
    @@index([companyId, createdAt])
    @@index([companyId, status, createdAt])
    @@index([companyId, paymentStatus, createdAt])
}

model OrderItem {
    id        String   @id @default(uuid())
    orderId   String
    productId String
    quantity  Decimal
    basePrice Decimal
    discount  Decimal?
    price     Decimal
    cost      Decimal

    order   Order   @relation(fields: [orderId], references: [id])
    product Product @relation(fields: [productId], references: [id])

    @@index([productId])
}

model OrderPayment {
    id            String        @id @default(uuid())
    orderId       String
    amount        Decimal
    paymentMethod PaymentMethod
    createdAt     DateTime      @default(now())
    reference     String?

    order Order @relation(fields: [orderId], references: [id])

    @@index([paymentMethod, createdAt])
}

enum PaymentStatus {
    OPEN
    PENDING
    PAID
}

model Supplier {
    id        String  @id @default(uuid())
    companyId String
    name      String
    active    Boolean @default(true)
    notes     String? @db.Text

    purchases Purchase[]
    company   Company    @relation(fields: [companyId], references: [id])

    @@index([companyId, active])
}

enum PurchaseStatus {
    DRAFT
    CONFIRMED
    RECEIVED
    CANCELED
}

model Purchase {
    id          String         @id @default(uuid())
    companyId   String
    supplierId  String
    status      PurchaseStatus @default(DRAFT)
    subtotal    Decimal
    total       Decimal
    createdAt   DateTime       @default(now())
    receivedAt  DateTime?
    warehouseId String
    notes       String?        @db.Text

    warehouse Warehouse @relation(fields: [warehouseId], references: [id])
    company   Company   @relation(fields: [companyId], references: [id])
    supplier  Supplier  @relation(fields: [supplierId], references: [id])

    items    PurchaseItem[]
    payments PurchasePayment[]

    @@index([companyId, createdAt])
    @@index([companyId, supplierId, createdAt])
}

model PurchaseItem {
    id         String  @id @default(uuid())
    purchaseId String
    productId  String
    quantity   Decimal
    cost       Decimal
    total      Decimal

    purchase Purchase @relation(fields: [purchaseId], references: [id])
    product  Product  @relation(fields: [productId], references: [id])

    @@index([productId])
}

model PurchasePayment {
    id            String        @id @default(uuid())
    purchaseId    String
    amount        Decimal
    paymentMethod PaymentMethod
    createdAt     DateTime      @default(now())
    reference     String?

    purchase Purchase @relation(fields: [purchaseId], references: [id])
}

enum PromotionType {
    DISCOUNT_PERCENT
    DISCOUNT_FIXED
    BUY_X_GET_Y
    COMBO
}

model Promotion {
    id        String        @id @default(uuid())
    companyId String
    name      String
    type      PromotionType
    discount  Decimal? // porcentaje o monto fijo
    active    Boolean       @default(true)
    startDate DateTime?
    endDate   DateTime?
    createdAt DateTime      @default(now())

    company Company         @relation(fields: [companyId], references: [id])
    items   PromotionItem[]

    @@index([companyId, active])
    @@index([companyId, startDate, endDate])
}

model PromotionItem {
    id          String   @id @default(uuid())
    promotionId String
    productId   String
    quantityMin Decimal?
    quantityMax Decimal?

    promotion Promotion @relation(fields: [promotionId], references: [id])
    product   Product   @relation(fields: [productId], references: [id])

    @@unique([promotionId, productId])
}

model Permission {
    id          String   @id @default(uuid())
    name        String   @unique
    description String?
    moduleId    String
    createdAt   DateTime @default(now())

    module          Module           @relation(fields: [moduleId], references: [id])
    rolePermissions RolePermission[]

    @@index([moduleId])
}

// Relación entre roles y permisos
model RolePermission {
    id           String @id @default(uuid())
    role         Role
    permissionId String

    permission Permission @relation(fields: [permissionId], references: [id])

    @@unique([role, permissionId])
}

// Ejemplo de roles existentes en tu UserCompany
enum Role {
    OWNER
    ADMIN
    EMPLOYEE
    READ_ONLY
    MANAGER
}

model Module {
    id          String  @id @default(uuid())
    code        String  @unique
    name        String
    description String?
    active      Boolean @default(true)

    companies   CompanyModule[]
    permissions Permission[]

    @@index([active])
}

model CompanyModule {
    id        String    @id @default(uuid())
    companyId String
    moduleId  String
    enabled   Boolean   @default(true)
    expiresAt DateTime?

    company Company @relation(fields: [companyId], references: [id])
    module  Module  @relation(fields: [moduleId], references: [id])

    @@unique([companyId, moduleId])
}

model SalesDaily {
    id         String   @id @default(uuid())
    companyId  String
    date       DateTime
    totalSales Decimal
    salesCount Int
    avgTicket  Decimal

    company Company @relation(fields: [companyId], references: [id])

    @@unique([companyId, date])
    @@index([companyId, date])
}

model SalesByProduct {
    id          String  @id @default(uuid())
    companyId   String
    productId   String
    unitsSold   Decimal
    totalAmount Decimal

    company Company @relation(fields: [companyId], references: [id])
    product Product @relation(fields: [productId], references: [id])

    @@unique([companyId, productId])
    @@index([companyId])
}

model ProfitByProduct {
    id        String  @id @default(uuid())
    companyId String
    productId String
    revenue   Decimal
    cost      Decimal
    profit    Decimal

    company Company @relation(fields: [companyId], references: [id])
    product Product @relation(fields: [productId], references: [id])

    @@unique([companyId, productId])
    @@index([companyId])
}

model CashDaily {
    id        String   @id @default(uuid())
    companyId String
    date      DateTime
    cashIn    Decimal
    cashOut   Decimal
    balance   Decimal

    company Company @relation(fields: [companyId], references: [id])

    @@unique([companyId, date])
    @@index([companyId, date])
}

model ProductNoRotation {
    id        String    @id @default(uuid())
    companyId String
    productId String
    lastSale  DateTime?
    daysIdle  Int

    company Company @relation(fields: [companyId], references: [id])
    product Product @relation(fields: [productId], references: [id])

    @@unique([companyId, productId])
}

model SalesByCategory {
    id         String  @id @default(uuid())
    companyId  String
    categoryId String
    totalSales Decimal
    unitsSold  Decimal

    company  Company         @relation(fields: [companyId], references: [id])
    category ProductCategory @relation(fields: [categoryId], references: [id])

    @@unique([companyId, categoryId])
    @@index([companyId])
}

model ProductCategory {
    id        String   @id @default(uuid())
    companyId String
    name      String
    createdAt DateTime @default(now())

    company           Company           @relation(fields: [companyId], references: [id])
    products          Product[]
    salesByCategories SalesByCategory[]

    @@unique([companyId, name])
    @@index([companyId])
}

model ModifierGroup {
    id        String   @id @default(uuid())
    companyId String
    name      String
    required  Boolean  @default(false)
    min       Int?
    max       Int?
    createdAt DateTime @default(now())

    company   Company                @relation(fields: [companyId], references: [id])
    modifiers Modifier[]
    products  ProductModifierGroup[]

    @@index([companyId])
}

model Modifier {
    id      String  @id @default(uuid())
    groupId String
    name    String
    price   Decimal @default(0)
    active  Boolean @default(true)

    salesItems SaleItemModifier[]

    group ModifierGroup @relation(fields: [groupId], references: [id])

    @@index([groupId, active])
}

model ProductModifierGroup {
    id        String @id @default(uuid())
    productId String
    groupId   String

    product Product       @relation(fields: [productId], references: [id])
    group   ModifierGroup @relation(fields: [groupId], references: [id])

    @@unique([productId, groupId])
}

model SaleItemModifier {
    id         String  @id @default(uuid())
    saleItemId String
    modifierId String
    price      Decimal

    saleItem SaleItem @relation(fields: [saleItemId], references: [id])
    modifier Modifier @relation(fields: [modifierId], references: [id])

    @@unique([saleItemId, modifierId])
}

model RefreshToken {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    companyId String?
    type      UserType
    expiresAt DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SalesBySaleCategory {
    id             String  @id @default(uuid())
    companyId      String
    saleCategoryId String
    totalSales     Decimal
    salesCount     Int

    company      Company      @relation(fields: [companyId], references: [id])
    saleCategory SaleCategory @relation(fields: [saleCategoryId], references: [id])

    @@unique([companyId, saleCategoryId])
    @@index([companyId])
}

model SaleCategory {
    id        String   @id @default(uuid())
    companyId String
    name      String
    color     String?
    active    Boolean  @default(true)
    createdAt DateTime @default(now())

    company         Company               @relation(fields: [companyId], references: [id])
    sales           Sale[]
    salesByCategory SalesBySaleCategory[]

    @@unique([companyId, name])
    @@index([companyId, active])
}

enum SaleStatus {
    COMPLETED
    CANCELED
}
